---
title: 'Advent Of Code: 2021-16'
author: Tan Ho
date: "`r Sys.Date()`"
output: html_document
---

```{r setup}
suppressPackageStartupMessages({
  library(R.utils)
  library(tidyverse)
  library(here)
  library(glue)
  
  knitr::opts_chunk$set(echo = TRUE)
})

options(scipen = 9999999)
options(dplyr.summarise.inform = FALSE)
```

--- Data ---

```{r eval = FALSE}
# tanho63/aoc.elf
aoc.elf::aoc_get(day = 16, year = 2021)
```

```{r}
input <- readLines(here::here("2021/day-16-input.txt"))
# example <- "38006F45291200"
example <- "D2FE28"
```

--- Part 1 ---

Helper functions for converting

```{r}
.hexbin <- tibble::tribble(
  ~hex, ~bin,
  "0", "0000",
   "1",  "0001",
   "2",  "0010",
   "3",  "0011",
   "4",  "0100",
   "5",  "0101",
   "6",  "0110",
   "7",  "0111",
   "8",  "1000",
   "9",  "1001",
   "A",  "1010",
   "B",  "1011",
   "C",  "1100",
   "D",  "1101",
   "E",  "1110",
   "F",  "1111"
  ) |> 
  deframe()
hex2bin <- function(hex){
  s <- strsplit(hex,"") |> unlist()
  
  paste(.hexbin[s],collapse = "")
}

bin2int <- function(bin){
  strtoi(bin,base = 2)
}


```

Identify packets. 

Function to parse:

- first three characters of the binary string are the version number
- next three characters of binary identify type ID which controls how the rest of the string is parsed

type id = 4 => literal binary value
type id != 4 => operator, also passes in the subpackets. 

functions 
- read packet version
- read packet type
- do operation for packet type

```{r}

packet <- hex2bin(example)

read_packet <- function(packet){
  
  packet_type <- read_packet_type(packet)
  packet_version <- read_packet_version(packet)
  
  ## LITERAL PACKETS (Type 4)
  if(packet_type == 4){
    # return(packet_version)
    literal <- read_literal_packet(packet)
    # For Part One
    return(
      list(version = packet_version,
           type = packet_type,
           unprocessed = literal$unprocessed)
    )
  }
  
  packet_versions <- c(packet_version)
  
  # SUBPACKETS 
  ## SUBPACKETS WITH A LENGTH CONSTRAINT
  length_type <- read_packet_length_type(packet)
  if(length_type == 0) {
    subpacket_bits <- read_subpacket_bits(packet)
    unprocessed <- substr(packet,23,23+subpacket_bits)
    while(str_length(unprocessed) > 0){
      returned_subpacket <- read_packet(unprocessed)
      packet_versions <- c(packet_versions, returned_subpacket$version) # TODO
      unprocessed <- returned_subpacket$unprocessed
    }
  }
  
  ## SUBPACKETS WITH A COUNT CONSTRAINT
  if(length_type == 1){
    subpacket_length <- read_subpacket_length(packet)
    unprocessed <- str_sub(packet,19,-1L)
    
    for(i in seq_len(subpacket_length)){
      returned_subpacket <- read_packet(unprocessed)
      packet_versions <- c(packet_versions, returned_subpacket$version) # TODO
      unprocessed <- returned_subpacket$unprocessed
    }
  }
  
  return(list(version = packet_versions,
              type = packet_type,
              unprocessed = ""))
}

read_literal_packet <- function(packet){
  packet_contents <- substr(packet,7,str_length(packet))
  x <- tibble(x = strsplit(packet_contents,"") |> unlist()) |> 
    mutate(
      n = row_number() %/% 5.0001 + 1
    ) |> 
    group_by(n) |> 
    mutate(
      h = first(x) |> as.numeric(),
      x = ifelse(row_number() == 1,"",x)
    ) |> 
    group_by(n,h) |> 
    summarise(x = paste0(x, collapse = "")) |> 
    ungroup() |> 
    mutate(
      cumsum_h = cumsum(h==0),
      keep = lag(cumsum_h,default = 0) == 0
    ) |> 
    filter(keep)
    
  unprocessed <- str_sub(packet_contents,max(x$n)*5+1)
  
  if(bin2int(unprocessed) == 0) unprocessed <- character()
  
  literal_value <- x |> 
    pull(x) |> 
    paste(collapse = "") |> 
    bin2int()
  
  return(list(value = literal_value, unprocessed = unprocessed))
}

read_packet_version <- function(packet){
  substr(packet,1,3) |> bin2int()
}

read_packet_type <- function(packet){
  substr(packet,4,6) |> bin2int()
}

read_packet_length_type <- function(packet){
  substr(packet,7,7) |> bin2int()
}

read_subpacket_bits <- function(packet){
  substr(packet,8,22) |> bin2int()
}

read_subpacket_length <- function(packet){
  substr(packet,8,18) |> bin2int()
}

packet |> read_packet()

```


--- Part 2 ---

```{r}

```

